<!doctype html>
<html lang="en">

<head>
    <title>IoTDash:Dashboard</title>

    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="assets/img/favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />

    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

    <link href="assets/css/animate.min.css" rel="stylesheet" />

    <link href="assets/css/light-bootstrap-dashboard.css" rel="stylesheet" />

    <link href="assets/css/my-style.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
        crossorigin="anonymous">
    <link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.cyan-light_blue.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
        crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/floatButton.css">

    <script type="text/javascript" src="http://cryptojs.altervista.org/api/functions_cryptography.js"></script>

    <script src="assets/js/Chart.bundle.js"></script>
    <script src="assets/js/Chart.bundle.min.js"></script>

    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-functions.js"></script>

    <script src="assets/js/firebase.js"></script>
	<script src="assets/js/main.js"></script>

</head>

<body>
    <div class="wrapper">
        <div>
            <nav class="navbar navbar-default navbar-fixed">
                <div class="container">
                    <div class="navbar-header">
                        <p class="navbar-brand">Dashboard</p>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-right">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle profile" data-toggle="dropdown">
                                    <script>
                                        $(".profile").html("Hello, 	" + name);
                                    </script>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <div class="content">
                <!-- DASHBOARD -->
                <div id="dashContainer" class="container">
                    <div class="row">

                        <div class="col-md-6">
                            <div class="card card-theme">
                                <canvas id="newChart"></canvas>
                            </div>
                        </div>

                        <button id="addWidgetBtn" type="button" class="btn btn-primary" data-toggle="modal" data-target="#widgetForm">
                            Add New Gadget
                        </button>
                        <!-- <button type="button" class="btn btn-primary" onclick="genData()">
                                Generate Random Data
                        </button> -->
                        <button type="button" class="btn btn-primary" onclick="genPlant(secret)">
                                Generate a Plant Data
                        </button>
                    </div>
                </div>
            </div>
            <!-- WidgetModal -->
	<div class="modal fade" id="widgetForm" tabindex="-1" role="dialog" aria-labelledby="widgetLabel">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="widgetLabel">Add New Gadget</h4>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label for="label_widget">Widget Type</label>
                            <select id="widgetType" class="form-control">
                                <option value="line">Line Chart</option>
                                <option value="bar">Bar Chart</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="label_widget">Device</label>
                            <select id="keepDevice" class="form-control">
                                
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="label_data">Data</label>
                            <select id="mainData" class="form-control">
                                <option value="humid">Humidity</option>
                                <option value="light">Light</option>
                                <option value="temp">Temperature</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" data-dismiss="modal" onclick="addWidget()">Add</button>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
</body>
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>

<script src="assets/js/bootstrap-checkbox-radio-switch.js"></script>

<script>
    function genData(){
        var database = firebase.database();
		var dayFormat = mainApp.GenTime();
		database.ref("tele/").push().set({
			humid: (Math.floor((Math.random() * 100) + 1)),
			temp: (Math.floor((Math.random() * 40) + 1)),
			light: (Math.floor((Math.random() * 40) + 1)),
			value: (Math.floor((Math.random() * 100) + 1)),
			time: dayFormat
		})
	}
    function genPlant(secret){
        var database = firebase.database();
		var dayFormat = mainApp.GenTime();
		var stamp = firebase.database.ServerValue.TIMESTAMP;
		database.ref("telemetry/"+ secret).push().set({
			humid: (Math.floor((Math.random() * 100) + 1)),
			temp: (Math.floor((Math.random() * 40) + 1)),
			light: (Math.floor((Math.random() * 40) + 1)),
			time: dayFormat,
			timestamp: stamp
		})
    }
    
    $('#addWidgetBtn').click(function( event ) {
		widgetModalConfig();
	});

	function widgetModalConfig() {
        console.log(111);
        var database = firebase.database();
		database.ref("users/" + uid + "/device/").once('value', function (snapshot) {
            console.log(222);
            if (snapshot.exists()) {
                console.log(555);
                
				var content = '';
                snapshot.forEach(function (data) {
					var val = data.val();
                    content += "<option value='"+val.secret+"'>"+val.name+"</option>";
                });
				$('#keepDevice').html(content);
            }
		});
	}

    function addWidget(){
		var mainData = $('#mainData').val();
		var type = $('#widgetType').val();
		var secret = $('#keepDevice').val();
		
		console.log(mainData);

		//mainApp.AddWidget(type, mainData);
		
		database.ref("telemetry/"+secret+"/").limitToLast(22).on('value', function (snapshot) {
		var arr = [];
		var time_arr = [];
			if (snapshot.exists()) {	
				snapshot.forEach(function (data, key) {
					var val = data.val();
					if (val[mainData]) {
						arr.push(val[mainData]);
						time_arr.push(val.time);
					}						
				});
			}
			console.log(arr);
			

			var simpleLine = new Chart($("#newChart"), {
				type: type,
				data: {
					labels: time_arr,
					datasets: [{
						label: mainData,
						data: arr,
						backgroundColor: myFillColor[0],
						borderColor: myBordorColor[0]
					}]
				},
				options:{
					"scales":{
						"yAxes":[{
							"ticks":{
								"beginAtZero":true
							}
						}]
					}
				}
			});
		});

	};
</script>

</html>